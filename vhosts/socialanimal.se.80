<VirtualHost *:80>

  ServerName www.socialanimal.se:80
  ServerAlias socialanimal.se dev.socialanimal.se loc.socialanimal.se

  DocumentRoot /srv/www/socialanimal.se

  <Directory /srv/www/socialanimal.se>

    # Allow from all as default.
    Order deny,allow

    # Allow symlinks.
    Options FollowSymLinks

    # Protect files and directories from prying eyes.
    <FilesMatch "\.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$">
      Deny from all
    </FilesMatch>

    # Set the default handler.
    DirectoryIndex index.php index.html index.htm

    # Make Drupal handle any 404 errors.
    ErrorDocument 404 /index.php

    # Force simple error message for requests for non-existent favicon.ico.
    <Files favicon.ico>
      ErrorDocument 404 "The requested file favicon.ico was not found."
    </Files>

    # Override some PHP 5 settings. More in sites/default/settings.php.
    <IfModule mod_php5.c>
      php_flag magic_quotes_gpc                 off
      php_flag magic_quotes_sybase              off
      php_flag register_globals                 off
      php_flag session.auto_start               off
      php_value mbstring.http_input             pass
      php_value mbstring.http_output            pass
      php_flag mbstring.encoding_translation    off

      php_admin_value memory_limit              128M
      php_admin_value upload_max_filesize       64M
      php_admin_value post_max_size             64M
      php_admin_value max_input_time            60
      php_admin_value max_execution_time        240

      php_admin_value apc.shm_size              128M
    </IfModule>

    # Cache non-dynamically generated pages.
    <IfModule mod_expires.c>

      ExpiresActive On
      ExpiresDefault "modification plus 1 year"

      <FilesMatch \.php$>
        ExpiresActive Off
      </FilesMatch>

    </IfModule>

    # Compress output.
    <IfModule mod_deflate.c>
      AddOutputFilterByType DEFLATE text/plain text/xml text/html text/css application/x-javascript
    </IfModule>

    <IfModule mod_rewrite.c>

      RewriteEngine on

      # Don't enforce subdomain for cron requests.
      RewriteRule ^cron.php$ - [L]

      # Enforce subdomain.
      RewriteCond %{HTTP_HOST} !^www\..+?(:.*)?$ [NC]
      RewriteCond %{HTTP_HOST} !^dev\..+?(:.*)?$ [NC]
      RewriteCond %{HTTP_HOST} !^loc\..+?(:.*)?$ [NC]
      RewriteRule ^ http://www.%{HTTP_HOST}%1%{REQUEST_URI} [L,R=301]

      # Route requests to Drupal's front controller.
      RewriteCond %{REQUEST_FILENAME} !-f
      RewriteCond %{REQUEST_FILENAME} !-d
      RewriteCond %{REQUEST_URI} !=/favicon.ico
      RewriteRule ^ index.php [L]

      # Rules to correctly serve gzip compressed CSS and JS files.
      # Requires both mod_rewrite and mod_headers to be enabled.
      <IfModule mod_headers.c>

        # Serve gzip compressed CSS files if they exist and the client accepts gzip.
        RewriteCond %{HTTP:Accept-encoding} gzip
        RewriteCond %{REQUEST_FILENAME}\.gz -s
        RewriteRule ^(.*)\.css $1\.css\.gz [QSA]

        # Serve gzip compressed JS files if they exist and the client accepts gzip.
        RewriteCond %{HTTP:Accept-encoding} gzip
        RewriteCond %{REQUEST_FILENAME}\.gz -s
        RewriteRule ^(.*)\.js $1\.js\.gz [QSA]

        # Serve correct content types, and prevent mod_deflate double gzip.
        RewriteRule \.css\.gz$ - [T=text/css,E=no-gzip:1]
        RewriteRule \.js\.gz$ - [T=text/javascript,E=no-gzip:1]

        <FilesMatch "(\.js\.gz|\.css\.gz)$">

          # Serve correct encoding type.
          Header append Content-Encoding gzip

          # Force proxies to cache gzipped & non-gzipped css/js files separately.
          Header append Vary Accept-Encoding

        </FilesMatch>

      </IfModule>

    </IfModule>

  </Directory>
  
  # Directory for private files.
  <Directory /srv/www/socialanimal.se/sites/default/files/private>
    Deny from all
  </Directory> 

  # Block XMP-RPC. Remove if XML-RPC is needed.
  <Location /xmlrpc.php>
    Deny from all
  </Location> 

  # Only allow request for cron.php from localhost.
  <Location /cron.php>
    Deny from all
    Allow from 127.0.0.1
  </Location> 

  # Only allow install.php to be executed from localhost.
  # To call install.php from external machine, use port forwarding, e.g.
  # ssh -L 8080:127.0.0.1:80 green8.nodeone.se
#  <Location /install.php>
#    Deny from all
#    Allow from 127.0.0.1
#  </Location> 

  # Only allow update.php to be executed from localhost.
  # To call update.php from external machine, use port forwarding, e.g.
  # ssh -L 8080:127.0.0.1:80 green8.nodeone.se
  <Location /update.php>
    Deny from all
    Allow from 127.0.0.1
  </Location> 

</VirtualHost>
